<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ユメタン Memorizer</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh;
            display:flex;
            justify-content:center;
            align-items:center;
            padding:20px;
        }
        .container {
            background:#fff;
            border-radius:20px;
            box-shadow:0 20px 60px rgba(0,0,0,.3);
            max-width:650px;
            width:100%;
            padding:40px 40px 30px;
        }
        h1 {
            color:#667eea;
            text-align:center;
            margin-bottom:25px;
            font-size:2em;
        }
        .settings {
            margin-bottom:25px;
            background:#f7f8ff;
            border:2px solid #e3e6ff;
            border-radius:15px;
            padding:18px 20px 14px;
        }
        .settings h2 {
            font-size:1rem;
            margin-bottom:10px;
            color:#4b55b5;
            letter-spacing:.5px;
        }
        .range-row {
            display:flex;
            flex-wrap:wrap;
            gap:10px;
            align-items:center;
            margin-bottom:12px;
        }
        .range-row label {
            font-size:.85rem;
            font-weight:600;
            color:#555;
        }
        .range-row input {
            width:110px;
            padding:8px 10px;
            font-size:0.95rem;
            border:2px solid #d4d9ff;
            border-radius:8px;
            transition:border-color .25s;
        }
        .range-row input:focus {
            outline:none;
            border-color:#667eea;
        }
        .settings .info {
            font-size:.75rem;
            color:#666;
            line-height:1.4;
            margin-top:2px;
        }
        .start-buttons {
            display:flex;
            gap:10px;
            margin-top:6px;
        }
        .btn {
            flex:1;
            padding:12px 14px;
            font-weight:700;
            font-size:.95rem;
            border:none;
            border-radius:10px;
            cursor:pointer;
            background:#667eea;
            color:#fff;
            transition:.3s;
            letter-spacing:.5px;
        }
        .btn:hover { background:#5568d3; transform:translateY(-2px); }
        .btn-secondary { background:#764ba2; }
        .btn-secondary:hover { background:#5f3a82; }
        .question-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:18px;
            padding-bottom:14px;
            border-bottom:2px solid #f0f0f0;
        }
        .question-type {
            background:#667eea;
            color:#fff;
            padding:8px 16px;
            border-radius:20px;
            font-size:.9em;
            font-weight:bold;
        }
        .question-number { color:#666; font-weight:bold; }
        .word-number {
            background:#764ba2;
            color:#fff;
            padding:4px 12px;
            border-radius:15px;
            font-size:.9em;
            margin-bottom:15px;
            display:inline-block;
        }
        .question-content { margin-bottom:25px; }
        .question-text {
            font-size:1.5em;
            color:#333;
            margin-bottom:20px;
            font-weight:bold;
            text-align:center;
            min-height:48px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .input-area { margin-bottom:20px; }
        input[type="text"]#answerInput {
            width:100%;
            padding:15px;
            font-size:1.05em;
            border:2px solid #e0e0e0;
            border-radius:10px;
            transition:border-color .3s;
        }
        input#answerInput:focus { outline:none; border-color:#667eea; }
        .choices {
            display:flex;
            flex-direction:column;
            gap:10px;
        }
        .choice-btn {
            background:#fff;
            border:2px solid #e0e0e0;
            padding:14px 15px;
            border-radius:10px;
            cursor:pointer;
            font-size:1em;
            text-align:left;
            transition:.3s;
            line-height:1.2;
        }
        .choice-btn:hover {
            background:#f5f5f5;
            border-color:#667eea;
            transform:translateX(5px);
        }
        .choice-btn.selected {
            background:#667eea;
            color:#fff;
            border-color:#667eea;
        }
        .button-group {
            display:flex;
            gap:10px;
            margin-top:8px;
            flex-wrap:wrap;
        }
        .button-group button {
            flex:1;
            padding:13px 12px;
            font-size:.95em;
            font-weight:600;
            border:none;
            border-radius:10px;
            cursor:pointer;
            transition:.3s;
        }
        .btn-submit { background:#667eea; color:#fff; }
        .btn-submit:hover { background:#5568d3; transform:translateY(-2px); }
        .btn-next { background:#764ba2; color:#fff; }
        .btn-next:hover { background:#5f3a82; transform:translateY(-2px); }
        .btn-answer { background:#444; color:#fff; }
        .btn-answer:hover { background:#222; transform:translateY(-2px); }
        .feedback {
            margin-top:18px;
            padding:14px 16px;
            border-radius:10px;
            font-weight:600;
            line-height:1.4;
            display:none;
            font-size:.95rem;
        }
        .feedback.correct {
            background:#d4edda;
            color:#155724;
            border:2px solid #c3e6cb;
            display:block;
        }
        .feedback.incorrect, .feedback.revealed {
            background:#f8d7da;
            color:#721c24;
            border:2px solid #f5c6cb;
            display:block;
        }
        .explanations {
            margin-top:14px;
            background:#f4f6ff;
            border:1px solid #d8def7;
            border-radius:10px;
            padding:12px 14px;
            font-size:.85rem;
            line-height:1.5;
        }
        .explanations h4 {
            margin:0 0 6px;
            font-size:.85rem;
            color:#394b9f;
            letter-spacing:.5px;
        }
        .explanations ul {
            list-style:disc;
            padding-left:20px;
            margin:0;
        }
        .explanations li { margin:2px 0; }
        .stats {
            display:flex;
            justify-content:space-around;
            margin-top:18px;
            padding-top:18px;
            border-top:2px solid #f0f0f0;
        }
        .stat-item { text-align:center; }
        .stat-label {
            font-size:.85em;
            color:#666;
            margin-bottom:5px;
            letter-spacing:.5px;
        }
        .stat-value {
            font-size:1.5em;
            font-weight:bold;
            color:#667eea;
        }
        .hidden { display:none !important; }
        .return-btn {
            margin-top:15px;
            width:100%;
            background:#444 !important;
        }
        .return-btn:hover { background:#222 !important; }
        @media (max-width:520px) {
            .question-text { font-size:1.3em; }
            .button-group { flex-direction:column; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div class="container">
    <h1>ユメタン Memorizer</h1>

    <div class="settings" id="settingsPanel">
        <h2>出題設定</h2>
        <div class="range-row">
            <label for="rangeStart">開始No.</label>
            <input type="number" id="rangeStart" placeholder="例: 651" min="1">
            <label for="rangeEnd">終了No.</label>
            <input type="number" id="rangeEnd" placeholder="例: 700" min="1">
        </div>
        <div class="info">
            範囲を空欄で開始→全登録単語から出題。欠番は自動除外。該当なしならエラー。
        </div>
        <div class="start-buttons">
            <button class="btn" id="startBtn">出題開始</button>
            <button class="btn btn-secondary" id="resetBtn" type="button">リセット</button>
        </div>
        <div style="margin-top: 12px;">
            <button class="btn" id="reviewBtn" style="width: 100%; background: #e74c3c;">間違えた問題を復習</button>
        </div>
    </div>

    <div id="questionArea" class="hidden">
        <div class="question-header">
            <span class="question-type" id="questionType">日→英</span>
            <span class="question-number">問題 <span id="currentQuestion">1</span>/<span id="totalQuestions">0</span></span>
        </div>

        <div class="word-number">No. <span id="wordNumber">---</span></div>

        <div class="question-content">
            <div class="question-text" id="questionText">ここに問題が表示されます</div>

            <div class="input-area hidden" id="inputArea">
                <input type="text" id="answerInput" placeholder="答えを入力してください (空欄送信可)">
            </div>

            <div class="choices hidden" id="choicesArea">
                <button class="choice-btn" data-choice="0"></button>
                <button class="choice-btn" data-choice="1"></button>
                <button class="choice-btn" data-choice="2"></button>
                <button class="choice-btn" data-choice="3"></button>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-submit" id="submitBtn">回答する</button>
            <button class="btn-answer" id="showAnswerBtn">答えを見る</button>
            <button class="btn-next hidden" id="nextBtn">次へ</button>
        </div>

        <div class="feedback" id="feedback"></div>
        <div id="explanations" class="explanations hidden"></div>

        <button id="backToSettingBtn" class="btn return-btn">設定に戻る</button>
    </div>

    <div class="stats hidden" id="statsPanel">
        <div class="stat-item">
            <div class="stat-label">正解</div>
            <div class="stat-value" id="correctCount">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">不正解</div>
            <div class="stat-value" id="incorrectCount">0</div>
        </div>
    </div>
</div>

<script>
const wordData = [
    { number:651, english:"interfere", japanese:"邪魔をする" },
    { number:652, english:"trust", japanese:"〜を信頼する" },
    { number:653, english:"suit", japanese:"〜に適する" },
    { number:654, english:"identify", japanese:"〜を確認する" },
    { number:655, english:"conclude", japanese:"〜であると結論を下す" },
    { number:656, english:"adopt", japanese:"〜を採用する" },
    { number:657, english:"match", japanese:"〜を調和する" },
    { number:658, english:"construct", japanese:"〜を組み立てる" },
    { number:659, english:"leak", japanese:"漏れる" },
    { number:660, english:"bow", japanese:"お辞儀する" },
    { number:661, english:"frighten", japanese:"〜をぎょっとさせる" },
    { number:662, english:"desert", japanese:"〜を見捨てる" },
    { number:663, english:"inherit", japanese:"〜を相続する" },
    { number:664, english:"greet", japanese:"〜にあいさつする" },
    { number:665, english:"distinguish", japanese:"〜を見分ける" },
    { number:666, english:"puzzle", japanese:"〜を困らせる" },
    { number:667, english:"cooperate", japanese:"協力する" },
    { number:668, english:"stress", japanese:"〜を強調する" },
    { number:669, english:"apologize", japanese:"謝る" },
    { number:670, english:"debate", japanese:"〜を論争する" },
    { number:671, english:"admit", japanese:"〜を認める" },
    { number:672, english:"propose", japanese:"〜提案する" },
    { number:673, english:"refrain", japanese:"慎む" },
    { number:674, english:"remind", japanese:"〜に思い出させる" },
    { number:675, english:"respond", japanese:"返事をする" },
    { number:676, english:"patient", japanese:"辛抱強い" },
    { number:677, english:"liberal", japanese:"気前の良い" },
    { number:678, english:"noble", japanese:"気品のある" },
    { number:679, english:"severe", japanese:"深刻な" },
    { number:680, english:"outstanding", japanese:"目立った" },
    { number:681, english:"senior", japanese:"先輩の" },
    { number:682, english:"junior", japanese:"後輩の" },
    { number:683, english:"superior", japanese:"優れている" },
    { number:684, english:"elderly", japanese:"年配の" },
    { number:685, english:"similar", japanese:"よく似た" },
    { number:686, english:"tender", japanese:"優しい" },
    { number:687, english:"tidy", japanese:"きちんとした" },
    { number:688, english:"loyal", japanese:"忠誠な" },
    { number:689, english:"enormous", japanese:"莫大な" },
    { number:690, english:"evil", japanese:"悪い" },
    { number:691, english:"individual", japanese:"個々の" },
    { number:692, english:"promising", japanese:"前途有望な" },
    { number:693, english:"jealous", japanese:"ねたんで" },
    { number:694, english:"ashamed", japanese:"恥じて" },
    { number:695, english:"sensitive", japanese:"敏感な" },
    { number:696, english:"capable", japanese:"有能な" },
    { number:697, english:"selfish", japanese:"利己的な" },
    { number:698, english:"humble", japanese:"謙虚な" },
    { number:699, english:"bold", japanese:"大胆な" },
    { number:700, english:"intelligent", japanese:"知能の高い" },
];

let activeWords = [];
let questions = [];
let currentQuestionIndex = 0;
let correctCount = 0;
let incorrectCount = 0;
let currentAnswer = null;
let selectedChoice = null;
let quizStarted = false;
let questionAnswered = false; // 新規: 回答/答え表示済み判定
let reviewMode = false; // 復習モード判定
let wordStats = {}; // 単語ごとの正答・誤答記録
let incorrectAnswers = []; // セッション中の間違えた答えを記録

// DOM
const settingsPanel = document.getElementById('settingsPanel');
const questionArea = document.getElementById('questionArea');
const statsPanel = document.getElementById('statsPanel');
const rangeStartInput = document.getElementById('rangeStart');
const rangeEndInput = document.getElementById('rangeEnd');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const reviewBtn = document.getElementById('reviewBtn');
const submitBtn = document.getElementById('submitBtn');
const nextBtn = document.getElementById('nextBtn');
const showAnswerBtn = document.getElementById('showAnswerBtn');
const backToSettingBtn = document.getElementById('backToSettingBtn');
const explanationsDiv = document.getElementById('explanations');

// localStorage関連関数
function loadWordStats() {
    const saved = localStorage.getItem('yumetan_word_stats');
    if (saved) {
        try {
            wordStats = JSON.parse(saved);
        } catch (e) {
            wordStats = {};
        }
    } else {
        wordStats = {};
    }
}

function saveWordStats() {
    localStorage.setItem('yumetan_word_stats', JSON.stringify(wordStats));
}

function recordAnswer(wordNumber, isCorrect) {
    if (!wordStats[wordNumber]) {
        wordStats[wordNumber] = { correct: 0, incorrect: 0 };
    }
    if (isCorrect) {
        wordStats[wordNumber].correct++;
    } else {
        wordStats[wordNumber].incorrect++;
    }
    saveWordStats();
}

function getAccuracy(wordNumber) {
    const stats = wordStats[wordNumber];
    if (!stats || (stats.correct + stats.incorrect) === 0) return null;
    return Math.round((stats.correct / (stats.correct + stats.incorrect)) * 100);
}

function getIncorrectWords() {
    const incorrectWordNumbers = [];
    for (const num in wordStats) {
        const stats = wordStats[num];
        // 誤答が1回以上あり、正答率が80%未満の単語
        if (stats.incorrect > 0 && getAccuracy(num) < 80) {
            incorrectWordNumbers.push(parseInt(num));
        }
    }
    return wordData.filter(w => incorrectWordNumbers.includes(w.number));
}

// 初期化時にlocalStorageから読み込み
loadWordStats();

function sanitizeRange() {
    let start = rangeStartInput.value.trim();
    let end = rangeEndInput.value.trim();
    if (!start && !end) return { start:null, end:null };
    if (start && !end) end = start;
    if (!start && end) start = end;
    start = parseInt(start,10);
    end = parseInt(end,10);
    if (isNaN(start) || isNaN(end)) return { start:null, end:null };
    if (start > end) [start,end] = [end,start];
    return { start, end };
}

startBtn.addEventListener('click', () => {
    reviewMode = false;
    const { start, end } = sanitizeRange();
    activeWords = (start === null && end === null)
        ? [...wordData]
        : wordData.filter(w => w.number >= start && w.number <= end);

    if (activeWords.length === 0) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({ icon:'error', title:'エラー', text:'指定範囲に単語データがありません。' });
        } else {
            alert('エラー\n\n指定範囲に単語データがありません。');
        }
        return;
    }
    currentQuestionIndex = 0;
    correctCount = 0;
    incorrectCount = 0;
    incorrectAnswers = [];
    updateStats();
    generateQuestions();
    displayQuestion();
    settingsPanel.classList.add('hidden');
    questionArea.classList.remove('hidden');
    statsPanel.classList.remove('hidden');
    quizStarted = true;
});

reviewBtn.addEventListener('click', () => {
    const incorrectWords = getIncorrectWords();
    if (incorrectWords.length === 0) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({ 
                icon:'info', 
                title:'復習する問題がありません', 
                text:'まだ間違えた問題がないか、全ての問題の正答率が80%以上です。'
            });
        } else {
            alert('復習する問題がありません\n\nまだ間違えた問題がないか、全ての問題の正答率が80%以上です。');
        }
        return;
    }
    reviewMode = true;
    activeWords = incorrectWords;
    currentQuestionIndex = 0;
    correctCount = 0;
    incorrectCount = 0;
    incorrectAnswers = [];
    updateStats();
    generateQuestions();
    displayQuestion();
    settingsPanel.classList.add('hidden');
    questionArea.classList.remove('hidden');
    statsPanel.classList.remove('hidden');
    quizStarted = true;
});

resetBtn.addEventListener('click', () => {
    if (quizStarted) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon:'question',
                title:'確認',
                text:'現在の進行状況をリセットしますか？',
                showCancelButton:true,
                confirmButtonText:'はい',
                cancelButtonText:'いいえ',
            }).then(r => { if (r.isConfirmed) hardReset(); });
        } else {
            if (confirm('現在の進行状況をリセットしますか？')) {
                hardReset();
            }
        }
    } else {
        hardReset();
    }
});

function hardReset() {
    rangeStartInput.value = '';
    rangeEndInput.value = '';
    activeWords = [];
    questions = [];
    currentQuestionIndex = 0;
    correctCount = 0;
    incorrectCount = 0;
    quizStarted = false;
    reviewMode = false;
    updateStats();
    questionArea.classList.add('hidden');
    statsPanel.classList.add('hidden');
    settingsPanel.classList.remove('hidden');
}

backToSettingBtn.addEventListener('click', () => {
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            icon:'question',
            title:'設定に戻りますか？',
            text:'現在のクイズ進行は破棄されます。',
            showCancelButton:true,
            confirmButtonText:'戻る',
            cancelButtonText:'キャンセル'
        }).then(res => { if (res.isConfirmed) hardReset(); });
    } else {
        if (confirm('設定に戻りますか？\n\n現在のクイズ進行は破棄されます。')) {
            hardReset();
        }
    }
});

function updateStats() {
    document.getElementById('correctCount').textContent = correctCount;
    document.getElementById('incorrectCount').textContent = incorrectCount;
}

function generateQuestions() {
    questions = [];
    // 日→英
    activeWords.forEach(w => {
        questions.push({
            type:'ja-en',
            word:w,
            question:w.japanese,
            answer:w.english
        });
    });
    // 英→日
    activeWords.forEach(w => {
        const choices = generateChoices(w);
        questions.push({
            type:'en-ja',
            word:w,
            question:w.english,
            answer:w.japanese,
            choices
        });
    });
    shuffleArray(questions);
    const totalQuestionsEl = document.getElementById('totalQuestions');
    if (totalQuestionsEl) {
        totalQuestionsEl.textContent = questions.length;
    }
}

function generateChoices(correctWord) {
    const choices = [correctWord.japanese];
    const others = activeWords.filter(w => w.number !== correctWord.number);
    const shuffled = [...others];
    shuffleArray(shuffled);
    for (let i=0; i<shuffled.length && choices.length<4; i++) {
        if (!choices.includes(shuffled[i].japanese)) choices.push(shuffled[i].japanese);
    }
    while (choices.length < 4) {
        choices.push(choices[Math.floor(Math.random()*choices.length)]);
    }
    shuffleArray(choices);
    return choices;
}

function shuffleArray(arr) {
    for (let i=arr.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
}

function displayQuestion() {
    if (currentQuestionIndex >= questions.length) {
        showResult();
        return;
    }
    const q = questions[currentQuestionIndex];
    currentAnswer = q.answer;
    selectedChoice = null;
    questionAnswered = false;

    document.getElementById('questionType').textContent =
        q.type === 'ja-en' ? '日→英 (スペル)' : '英→日 (選択)';
    document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
    document.getElementById('totalQuestions').textContent = questions.length;
    document.getElementById('wordNumber').textContent = q.word.number;
    document.getElementById('questionText').textContent = q.question;

    const feedback = document.getElementById('feedback');
    feedback.className = 'feedback';
    feedback.style.display = 'none';
    explanationsDiv.classList.add('hidden');
    explanationsDiv.innerHTML = '';

    submitBtn.classList.remove('hidden');
    showAnswerBtn.classList.remove('hidden');
    nextBtn.classList.add('hidden');

    if (q.type === 'ja-en') {
        document.getElementById('inputArea').classList.remove('hidden');
        document.getElementById('choicesArea').classList.add('hidden');
        const ans = document.getElementById('answerInput');
        ans.value = '';
        ans.focus();
    } else {
        document.getElementById('inputArea').classList.add('hidden');
        document.getElementById('choicesArea').classList.remove('hidden');
        const choiceBtns = document.querySelectorAll('.choice-btn');
        choiceBtns.forEach((btn, idx) => {
            btn.textContent = q.choices[idx];
            btn.classList.remove('selected');
            btn.onclick = () => selectChoice(idx);
        });
    }
}

function selectChoice(index) {
    if (questionAnswered) return;
    selectedChoice = index;
    const choiceBtns = document.querySelectorAll('.choice-btn');
    choiceBtns.forEach((btn,i)=>btn.classList.toggle('selected', i===index));
}

function checkAnswer(forceReveal=false) {
    if (questionAnswered) return;

    const q = questions[currentQuestionIndex];
    let userAnswer = '';
    let isCorrect = false;

    if (q.type === 'ja-en') {
        userAnswer = document.getElementById('answerInput').value.trim().toLowerCase();
        // 空欄許可: そのまま不正解扱い
        if (!forceReveal) {
            isCorrect = userAnswer.length > 0 && userAnswer === currentAnswer.toLowerCase();
        }
    } else {
        if (!forceReveal && selectedChoice !== null) {
            userAnswer = q.choices[selectedChoice];
            isCorrect = userAnswer === currentAnswer;
        } else {
            // 未選択で答え表示した / 強制表示
            isCorrect = false;
        }
    }

    questionAnswered = true;

    const feedback = document.getElementById('feedback');
    if (forceReveal) {
        feedback.textContent = `【答え】 ${formatAnswerText(q)}（※答え表示）`;
        feedback.className = 'feedback revealed';
        incorrectCount++; // 表示＝不正解扱い
        recordAnswer(q.word.number, false);
        // 間違えた答えを記録
        incorrectAnswers.push({
            word: q.word,
            questionType: q.type,
            question: q.question,
            correctAnswer: q.answer,
            userAnswer: '（答えを表示）',
            wasRevealed: true
        });
    } else if (isCorrect) {
        feedback.textContent = `正解！ / 正答: ${formatAnswerText(q)}`;
        feedback.className = 'feedback correct';
        correctCount++;
        recordAnswer(q.word.number, true);
    } else {
        feedback.textContent = `不正解… 正答: ${formatAnswerText(q)}`;
        feedback.className = 'feedback incorrect';
        incorrectCount++;
        recordAnswer(q.word.number, false);
        // 間違えた答えを記録
        incorrectAnswers.push({
            word: q.word,
            questionType: q.type,
            question: q.question,
            correctAnswer: q.answer,
            userAnswer: userAnswer || '（未回答）',
            wasRevealed: false
        });
    }
    feedback.style.display = 'block';
    updateStats();

    // 選択肢解説
    if (q.type === 'en-ja') {
        buildChoiceExplanations(q);
    } else {
        // ja-en の場合も英語を再確認できるよう軽い表示は既に feedback に含む
    }

    submitBtn.classList.add('hidden');
    showAnswerBtn.classList.add('hidden');
    nextBtn.classList.remove('hidden');
}

function formatAnswerText(q) {
    if (q.type === 'ja-en') {
        return `${q.answer}（${q.word.japanese}）`;
    } else {
        return `${q.answer}（${q.word.english}）`;
    }
}

function buildChoiceExplanations(q) {
    // q.choices (Japanese). それぞれに対応する英単語を検索
    const listItems = q.choices.map(jp => {
        const entry = wordData.find(w => w.japanese === jp);
        const en = entry ? entry.english : '未登録';
        const isCorrect = jp === q.answer;
        return `<li>${jp} ： ${en}${isCorrect ? ' <span style="color:#c0392b;">← 正答</span>' : ''}</li>`;
    }).join('');
    explanationsDiv.innerHTML = `
        <h4>選択肢解説</h4>
        <ul>${listItems}</ul>
    `;
    explanationsDiv.classList.remove('hidden');
}

function nextQuestion() {
    currentQuestionIndex++;
    displayQuestion();
}

function showResult() {
    const total = questions.length;
    const percentage = total === 0 ? 0 : Math.round((correctCount / total) * 100);

    // 間違えた答えのセクションを作成
    let incorrectAnswersHtml = '';
    if (incorrectAnswers.length > 0) {
        incorrectAnswersHtml = '<div style="margin-top:30px; max-height:400px; overflow-y:auto;">';
        incorrectAnswersHtml += '<h3 style="color:#e74c3c; font-size:1.1em; margin-bottom:15px;">間違えた問題</h3>';
        incorrectAnswersHtml += '<div style="display:grid; gap:12px;">';
        
        incorrectAnswers.forEach((item, index) => {
            const typeLabel = item.questionType === 'ja-en' ? '日→英' : '英→日';
            incorrectAnswersHtml += `
                <div style="background:#fff5f5; padding:14px; border-radius:8px; border-left:4px solid #e74c3c;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span style="font-weight:600; color:#333;">No.${item.word.number} ${item.word.english}</span>
                        <span style="background:#e74c3c; color:#fff; padding:2px 8px; border-radius:4px; font-size:0.85em;">${typeLabel}</span>
                    </div>
                    <div style="margin-bottom:6px;">
                        <span style="font-weight:600; color:#555;">問題:</span> ${item.question}
                    </div>
                    <div style="margin-bottom:4px;">
                        <span style="font-weight:600; color:#e74c3c;">あなたの答え:</span> <span style="color:#c0392b;">${item.userAnswer}</span>
                    </div>
                    <div>
                        <span style="font-weight:600; color:#27ae60;">正しい答え:</span> <span style="color:#229954;">${item.correctAnswer}</span>
                    </div>
                </div>
            `;
        });
        
        incorrectAnswersHtml += '</div></div>';
    }

    // 各単語の統計情報を表示
    let wordStatsHtml = '<div style="margin-top:30px; max-height:300px; overflow-y:auto;">';
    wordStatsHtml += '<h3 style="color:#667eea; font-size:1.1em; margin-bottom:15px;">単語別正答率</h3>';
    wordStatsHtml += '<div style="display:grid; gap:8px;">';
    
    activeWords.forEach(word => {
        const accuracy = getAccuracy(word.number);
        const stats = wordStats[word.number];
        if (stats && (stats.correct + stats.incorrect) > 0) {
            const color = accuracy >= 80 ? '#27ae60' : accuracy >= 50 ? '#f39c12' : '#e74c3c';
            wordStatsHtml += `
                <div style="background:#f8f9fa; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; border-left:4px solid ${color};">
                    <span style="font-weight:600;">No.${word.number} ${word.english}</span>
                    <span style="color:${color}; font-weight:bold;">${accuracy}% (${stats.correct}/${stats.correct + stats.incorrect})</span>
                </div>
            `;
        }
    });
    
    wordStatsHtml += '</div></div>';

    questionArea.innerHTML = `
        <div style="text-align:center; padding:40px 0;">
            <h2 style="color:#667eea; margin-bottom:20px;">お疲れ様でした！</h2>
            <div style="font-size:3em; font-weight:bold; color:#764ba2; margin:20px 0;">
                ${percentage}%
            </div>
            <div style="font-size:1.2em; color:#666; margin-bottom:30px;">
                ${correctCount}/${total} 問正解
            </div>
            <button id="retryBtn"
                style="background:#667eea; color:#fff; padding:15px 40px;
                       border:none; border-radius:10px; font-size:1.1em;
                       font-weight:bold; cursor:pointer; margin-right:10px;">
                同じ範囲でもう一度
            </button>
            <button id="toSettingBtn"
                style="background:#764ba2; color:#fff; padding:15px 40px;
                       border:none; border-radius:10px; font-size:1.1em;
                       font-weight:bold; cursor:pointer;">
                設定に戻る
            </button>
            ${incorrectAnswersHtml}
            ${wordStatsHtml}
        </div>
    `;
    document.getElementById('retryBtn').onclick = () => {
        currentQuestionIndex = 0;
        correctCount = 0;
        incorrectCount = 0;
        incorrectAnswers = [];
        updateStats();
        rebuildQuestionArea();
        generateQuestions();
        displayQuestion();
    };
    document.getElementById('toSettingBtn').onclick = () => {
        hardReset();
    };
}

function rebuildQuestionArea() {
    questionArea.innerHTML = `
        <div class="question-header">
            <span class="question-type" id="questionType">日→英</span>
            <span class="question-number">問題 <span id="currentQuestion">1</span>/<span id="totalQuestions">0</span></span>
        </div>
        <div class="word-number">No. <span id="wordNumber">---</span></div>
        <div class="question-content">
            <div class="question-text" id="questionText">ここに問題が表示されます</div>
            <div class="input-area hidden" id="inputArea">
                <input type="text" id="answerInput" placeholder="答えを入力してください (空欄送信可)">
            </div>
            <div class="choices hidden" id="choicesArea">
                <button class="choice-btn" data-choice="0"></button>
                <button class="choice-btn" data-choice="1"></button>
                <button class="choice-btn" data-choice="2"></button>
                <button class="choice-btn" data-choice="3"></button>
            </div>
        </div>
        <div class="button-group">
            <button class="btn-submit" id="submitBtn">回答する</button>
            <button class="btn-answer" id="showAnswerBtn">答えを見る</button>
            <button class="btn-next hidden" id="nextBtn">次へ</button>
        </div>
        <div class="feedback" id="feedback"></div>
        <div id="explanations" class="explanations hidden"></div>
        <button id="backToSettingBtn" class="btn return-btn">設定に戻る</button>
    `;
    // 再バインド
    document.getElementById('submitBtn').addEventListener('click', ()=>checkAnswer(false));
    document.getElementById('showAnswerBtn').addEventListener('click', ()=>checkAnswer(true));
    document.getElementById('nextBtn').addEventListener('click', nextQuestion);
    document.getElementById('backToSettingBtn').addEventListener('click', ()=> {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon:'question',
                title:'設定に戻りますか？',
                text:'現在のクイズ進行は破棄されます。',
                showCancelButton:true,
                confirmButtonText:'戻る',
                cancelButtonText:'キャンセル'
            }).then(res=>{ if (res.isConfirmed) hardReset(); });
        } else {
            if (confirm('設定に戻りますか？\n\n現在のクイズ進行は破棄されます。')) {
                hardReset();
            }
        }
    });
    document.addEventListener('keydown', globalKeyHandler);
    // DOM参照更新
    explanationsDiv = document.getElementById('explanations');
}

function globalKeyHandler(e) {
    if (e.key === 'Enter') {
        const submitVisible = document.getElementById('submitBtn') && !document.getElementById('submitBtn').classList.contains('hidden');
        const nextVisible = document.getElementById('nextBtn') && !document.getElementById('nextBtn').classList.contains('hidden');
        if (submitVisible) {
            checkAnswer(false);
        } else if (nextVisible) {
            nextQuestion();
        }
    }
}

// 初期バインド
submitBtn.addEventListener('click', ()=>checkAnswer(false));
showAnswerBtn.addEventListener('click', ()=>checkAnswer(true));
nextBtn.addEventListener('click', nextQuestion);
document.addEventListener('keydown', globalKeyHandler);
rangeEndInput.addEventListener('keydown', e => { if (e.key === 'Enter') startBtn.click(); });
rangeStartInput.addEventListener('keydown', e => { if (e.key === 'Enter') startBtn.click(); });
</script>
</body>
</html>
